/*! For license information please see index.js.LICENSE.txt */
import*as e from"react";import{Class as t,DocStack as r}from"@docstack/client";var n={85:(e,t,r)=>{e.exports=r(335)},335:(e,t,r)=>{var n=r(649),o=Symbol.for("react.element"),s=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),c=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};t.jsx=function(e,t,r){var n,a={},u=null,l=null;for(n in void 0!==r&&(u=""+r),void 0!==t.key&&(u=""+t.key),void 0!==t.ref&&(l=t.ref),t)s.call(t,n)&&!i.hasOwnProperty(n)&&(a[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===a[n]&&(a[n]=t[n]);return{$$typeof:o,type:e,key:u,ref:l,props:a,_owner:c.current}}},649:t=>{t.exports=e}},o={};function s(e){var t=o[e];if(void 0!==t)return t.exports;var r=o[e]={exports:{}};return n[e](r,r.exports,s),r.exports}s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var c=s(85),i=s(649);const a=(0,i.createContext)(null),u=e=>{const{config:t,children:n}=e,o=(0,i.useRef)(null),[s,u]=(0,i.useState)(null),l=(0,i.useCallback)(()=>{u(o.current)},[]);return(0,i.useEffect)(()=>{if(null===o.current&&t.length){console.log("DocStack provider - init instance",{config:t});const e=new r(...t);o.current=e,o.current.addEventListener("ready",l)}return()=>{o.current}},[t,l]),(0,c.jsx)(a.Provider,{value:s,children:n})};var l=function(e,t,r,n){return new(r||(r=Promise))(function(o,s){function c(e){try{a(n.next(e))}catch(e){s(e)}}function i(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(c,i)}a((n=n.apply(e,t||[])).next())})};const d=(e,t,...r)=>{const n=(0,i.useContext)(a),[o,s]=(0,i.useState)({rows:[],ast:[]}),[c,u]=(0,i.useState)(!0),[d,f]=(0,i.useState)(null),v=(0,i.useRef)(!1);return(0,i.useEffect)(()=>n?(v.current?console.log("Already performing query"):(v.current=!0,u(!0),l(void 0,void 0,void 0,function*(){try{const o=n.getStack(e);if(o){console.log("Preparing to run query",{sql:t,params:r});const e=yield o.query(t,...r);s(e)}else console.log("Could not find corresponding stack",{stack:e})}catch(e){console.log("Got error while running query",{error:e}),f(e)}finally{u(!1)}})),()=>{}):(console.error("useClassList must be used within a DocStackProvider."),void u(!1)),[n,e,r]),{loading:c,result:o,error:d}},f=(e,t,r,n=50)=>{const o=(0,i.useContext)(a),[s,c]=(0,i.useState)([]),[u,d]=(0,i.useState)(!0),[f,v]=(0,i.useState)(null);return(0,i.useEffect)(()=>{if(!o)return console.error("useFind must be used within a DocStackProvider."),void d(!1);d(!0),l(void 0,void 0,void 0,function*(){try{const r=o.getStack(e);if(r){const e=yield r.findDocuments(t.selector,t.fields);if(e.docs.length){let t=e.docs;c(t)}}}catch(e){v(e)}finally{d(!1)}});const r=e=>{};return o.addEventListener("change",r),()=>{o.removeEventListener("change",r)}},[o,JSON.stringify(t)]),{docs:s,loading:u,error:f}};var v=function(e,t,r,n){return new(r||(r=Promise))(function(o,s){function c(e){try{a(n.next(e))}catch(e){s(e)}}function i(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(c,i)}a((n=n.apply(e,t||[])).next())})};const y=e=>{const r=(0,i.useContext)(a);return(0,i.useCallback)((n,o)=>v(void 0,void 0,void 0,function*(){try{if(!r)return console.error("useClassCreate must be used within a DocStackProvider."),Promise.resolve(null);const s=r.getStack(e);if(s){const e=yield t.create(s,n,"class",o);return yield s.addClass(e),e}return null}catch(e){return console.error(e),null}}),[r,e])},g=e=>{const{stack:t,filter:r,search:n}=e,o=(0,i.useContext)(a),[s,c]=(0,i.useState)(!1),[u,l]=(0,i.useState)(),[d,f]=(0,i.useState)([]),y=(0,i.useRef)(!1);return(0,i.useEffect)(()=>{if(!o)return console.error("useClassList must be used within a DocStackProvider."),void c(!1);const e=e=>{f([...e.detail])};return y.current?console.log("Already performing query"):(y.current=!0,c(!0),v(void 0,void 0,void 0,function*(){try{const s=o.getStack(t);if(s){const t=yield s.getClasses({filter:r,search:n});f(t),s.addEventListener("classListChange",e)}}catch(e){l(e)}finally{c(!1)}})),()=>{f([]);const r=o.getStack(t);r&&r.removeEventListener("classListChange",e)}},[o,t,r,n]),{loading:s,classList:d,error:u}},h=(e,t)=>{const r=(0,i.useContext)(a),[n,o]=(0,i.useState)(!1),[s,c]=(0,i.useState)(),[u,l]=(0,i.useState)(),d=(0,i.useRef)(!1);return(0,i.useEffect)(()=>r?(d.current||(d.current=!0,o(!0),v(void 0,void 0,void 0,function*(){try{const n=r.getStack(e);if(n){const e=yield n.getClass(t);e&&l(e)}}catch(e){c(e)}finally{o(!1)}})),()=>{}):(console.error("useClass must be used within a DocStackProvider."),void o(!1)),[r,e,t]),{loading:n,error:s,classObj:u}},S=(e,t,r={})=>{const n=(0,i.useContext)(a),[o,s]=(0,i.useState)(),[c,u]=(0,i.useState)([]),l=(0,i.useRef)([]),[d,f]=(0,i.useState)(!0),[y,g]=(0,i.useState)(null);return(0,i.useEffect)(()=>{if(n&&t)return v(void 0,void 0,void 0,function*(){f(!0),g(null);try{const r=n.getStack(e);if(r){const e=yield r.getClass(t);e&&s(e)}}catch(e){g(e),f(!1)}}),()=>{};f(!1)},[n,e,t]),(0,i.useEffect)(()=>{o&&v(void 0,void 0,void 0,function*(){f(!0);try{const e=yield o.getCards(r);l.current=e,u(l.current)}catch(e){g(e)}finally{f(!1)}const e=e=>{const t=e.detail.doc;if(console.log("useClassDocs - detail",{detail:e.detail}),t.active){console.log("useClassDocs - a doc was changed or added",{doc:t});const e=l.current.findIndex(e=>e._id==t._id);-1!=e?(console.log("useClassDocs - a doc was changed",{doc:t}),l.current=[...l.current.slice(0,e),t,...l.current.slice(e+1,l.current.length)]):(console.log("useClassDocs - a doc was added",{doc:t}),l.current.push(t))}else{console.log("useClassDocs - a doc was deleted",{doc:t});const e=l.current.findIndex(e=>e._id==t._id);-1!=e&&(l.current=[...l.current.slice(0,e),...l.current.slice(e+1,l.current.length)])}u([...l.current])};return o.addEventListener("doc",e),()=>{o.removeEventListener("doc",e)}})},[o,JSON.stringify(r)]),{docs:c,loading:d,error:y}};export{a as DocStackContext,u as StackProvider,h as useClass,y as useClassCreate,S as useClassDocs,g as useClassList,f as useFind,d as useQuerySQL};
//# sourceMappingURL=index.js.map