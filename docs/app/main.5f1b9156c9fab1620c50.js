(self.webpackChunk_docstack_ui=self.webpackChunk_docstack_ui||[]).push([[8792],{4002:(e,t,s)=>{"use strict";s.a(e,async(e,a)=>{try{s.d(t,{M:()=>l});var r=s(50523),i=s(85288),n=s(43820),o=s(27768),c=s(19928);const e=await(0,c.C7)(),l=(0,r.U1)({reducer:{ui:i.A,auth:n.Ay,stack:o.A},middleware:e=>e().concat(c.Q4),preloadedState:e});a()}catch(e){a(e)}},1)},10881:(e,t,s)=>{"use strict";s.r(t),s.d(t,{countPatches:()=>a,importJsonFile:()=>r});const a=()=>{let e=0;try{const t=s(81463);console.log("getPatchCount - Browser: counting files via require.context"),e=t.keys().length,console.log(`countPatches - total number of patches: ${e}`)}catch(e){console.log("countPatches - problem while reading patch folder",e)}return e},r=async e=>{try{return console.log("importJsonFile - Browser: importing file via require"),s(97174)(`./${e}`)}catch(e){throw console.error("Error reading JSON file:",e),e}}},11580:()=>{},13653:(e,t,s)=>{"use strict";s.d(t,{MI:()=>n,M_:()=>o,me:()=>d,Iz:()=>c,Xm:()=>u,Oo:()=>l});var a=s(31085),r=s(14041),i=s(87271);const n=(0,r.createContext)(null),o=e=>{const{config:t,children:s}=e,o=r.useRef(null),[c,l]=(0,r.useState)(null),d=r.useCallback(()=>{l(o.current)},[]);return(0,r.useEffect)(()=>{if(null===o.current){console.log("DocStack provider - init instance");const e=new i.jg(...t);o.current=e,o.current.addEventListener("ready",d)}return()=>{o.current}},[t,d]),(0,a.jsx)(n.Provider,{value:c,children:s})},c=e=>{const t=r.useContext(n);return r.useCallback(async(s,a)=>{try{if(!t)return console.error("useClassCreate must be used within a DocStackProvider."),Promise.resolve(null);const r=t.getStack(e);if(r){const e=await i.Xs.create(r,s,"class",a);return await r.addClass(e),e}return null}catch(e){return console.error(e),null}},[t,e])},l=e=>{const t=r.useContext(n),[s,a]=r.useState(!1),[i,o]=r.useState(),[c,l]=r.useState([]),d=r.useRef(!1);return r.useEffect(()=>t?(d.current?console.log("Already performing query"):(d.current=!0,a(!0),(async()=>{try{const s=t.getStack(e);if(s){const e=await s.getAllClasses();e.length&&l(e)}}catch(e){o(e)}finally{a(!1)}})()),()=>{l([])}):(console.error("useClassList must be used within a DocStackProvider."),void a(!1)),[t,e]),{loading:s,classList:c,error:i}},d=(e,t)=>{const s=r.useContext(n),[a,i]=r.useState(!1),[o,c]=r.useState(),[l,d]=r.useState(),u=r.useRef(!1);return r.useEffect(()=>s?(u.current||(u.current=!0,i(!0),(async()=>{try{const a=s.getStack(e);if(a){const e=await a.getClass(t);e&&d(e)}}catch(e){c(e)}finally{i(!1)}})()),()=>{}):(console.error("useClass must be used within a DocStackProvider."),void i(!1)),[s,e,t]),{loading:a,error:o,classObj:l}},u=(e,t,s={})=>{const a=r.useContext(n),[i,o]=r.useState(),[c,l]=r.useState([]),d=r.useRef([]),[u,h]=r.useState(!0),[m,g]=r.useState(null);return r.useEffect(()=>{if(a&&t)return(async()=>{h(!0),g(null);try{const s=a.getStack(e);if(s){const e=await s.getClass(t);e&&o(e)}}catch(e){g(e),h(!1)}})(),()=>{};h(!1)},[a,e,t]),r.useEffect(()=>{i&&(async()=>{h(!0);try{const e=await i.getCards(s);d.current=e,l(d.current)}catch(e){g(e)}finally{h(!1)}i.addEventListener("doc",e=>{const t=e.detail.doc;if(console.log("useClassDocs - detail",{detail:e.detail}),t.active){console.log("useClassDocs - a doc was changed or added",{doc:t});const e=d.current.findIndex(e=>e._id==t._id);-1!=e?(console.log("useClassDocs - a doc was changed",{doc:t}),d.current=[...d.current.slice(0,e),t,...d.current.slice(e+1,d.current.length)]):(console.log("useClassDocs - a doc was added",{doc:t}),d.current.push(t))}else{console.log("useClassDocs - a doc was deleted",{doc:t});const e=d.current.findIndex(e=>e._id==t._id);-1!=e&&(d.current=[...d.current.slice(0,e),...d.current.slice(e+1,d.current.length)])}l([...d.current])})})()},[i,JSON.stringify(s)]),{docs:c,loading:u,error:m}}},14168:()=>{},19928:(e,t,s)=>{"use strict";s.d(t,{C7:()=>o,LZ:()=>n,Q4:()=>c});var a=s(57822),r=s(87271);const i=new a.A("redux_state"),n=async e=>{try{const e=new r.jg({name:"client-test"});let t;e.addEventListener("ready",async s=>{if(t=e.getStack("client-test")){const e=await r.Xs.create(t,"Test","class","A test",{});var a=new r.nW(e,"text","string","A test attribute",{maxLength:50,primaryKey:!0,mandatory:!0});await r.nW.build(a),await e.addCard({text:"Hello"})}})}catch(e){console.error(e)}},o=async()=>{try{const e=await i.get("state");return console.log("loadState - loaded doc",e),e.state}catch(e){return 404===e.status?void 0:void console.error(e)}},c=e=>e=>async t=>e(t)},20073:(e,t,s)=>{"use strict";s.d(t,{A:()=>T});var a=s(31085),r=s(43705);const i=()=>(0,r.wA)(),n=r.d4;var o=s(18690),c=s(98870),l=s(14041),d=s(43820),u=s(50523),h=s(19928);const m=(0,u.zD)("testRequest",async(e,t)=>await(async()=>{var e="same-origin";return console.log("doTestRequest - credentialsConfig",e),(await fetch("http://localhost:5000/api/test",{method:"GET",mode:"cors",credentials:e,headers:{"Content-Type":"application/json"}})).json()})()),g=(0,u.zD)("saveState",async(e,t)=>{const s=t.getState();console.log("saveStateAction - Got state",s),await(0,h.LZ)(s)});(0,u.vy)({test:"test"},e=>{e.addCase(m.fulfilled,(e,t)=>{console.log(t.payload)}).addCase(g.fulfilled,(e,t)=>{})});var p=s(27768);const y=()=>{const e=i(),[t,r]=l.useState("browser"),n=(0,l.useCallback)(s=>{if("server"!=t)throw new Error("Unexpected form data for anonymous login");e((0,d.iD)(s)),e((0,p.S)("client-test"))},[e,t]),o=l.useCallback(()=>{if("browser"!=t)throw new Error("should have run credentials form submit");e((0,d.lp)()),e((0,p.S)("client-test"))},[e,t]),u=((0,l.useCallback)(()=>{e(g(!0))},[e]),l.useCallback(e=>{r("browser"!=e&&e?"server":"browser")},[r])),h=l.useMemo(()=>(0,a.jsxs)(c.Form,{style:{display:"server"==t?"block":"none"},name:"login-form",submit:(0,a.jsx)(c.Button,{type:"primary",children:"Login"}),onSubmit:n,children:[(0,a.jsx)(c.TextInput,{htmlType:"text",name:"username",label:"Username",placeholder:"a.username"}),(0,a.jsx)(c.TextInput,{htmlType:"password",name:"password",label:"Password",placeholder:"a.password"}),(0,a.jsx)(c.TextInput,{htmlType:"text",name:"serverURL",label:"Server URL",placeholder:"http://localhost:5000"})]}),[t,n]);return(0,a.jsxs)("div",{className:"view-auth",children:[(0,a.jsx)("div",{className:"view-auth-hero",children:(0,a.jsx)("div",{className:"view-auth-hero-fill",style:{backgroundImage:`url("${s(31297)}")`}})}),(0,a.jsx)("div",{className:"view-auth-content",children:(0,a.jsx)(c.Card,{style:{width:"fit-content",height:"fit-content"},orientation:"vertical",padding:"m",borderRadius:"md",headerClass:"view-auth-content-head",header:(0,a.jsx)("h1",{children:"Login"}),footer:(0,a.jsx)(c.ActionBar,{items:[{position:"left",key:"target-selector",item:(0,a.jsx)(c.Select,{placeholder:"Target",options:[{value:"server",element:"Server",selected:"server"==t},{value:"browser",element:"Browser",selected:"browser"==t}],onChange:e=>u(e),multiple:!1})},{position:"right",key:"btn-browser-login",item:(0,a.jsx)(c.Button,{type:"primary",onClick:o,children:"Access"})}]}),children:h})})]})};var f=s(13653),b=s(73657);const w=e=>{const{name:t,description:s,attributes:r}=e,i=l.useMemo(()=>{let e={};return null==r||r.forEach(t=>{console.log("attribute model",{model:t.model});let s=t.model;s.config=JSON.stringify(s.config),e[t.name]=s}),e},[r]);return(0,a.jsxs)(c.Card,{className:"class-card",header:(0,a.jsx)(c.ActionBar,{className:"dashboard-class-header",items:[{position:"left",key:"class-title",item:(0,a.jsx)("h3",{children:t})},{position:"right",key:"class-link",item:(0,a.jsx)(b.N_,{to:`/class/${t}`,children:(0,a.jsx)(c.Button,{type:"primary",iconName:"chevron-right"})})}]}),children:[(0,a.jsx)("span",{children:s}),(0,a.jsx)("h4",{children:"Attributes:"}),(0,a.jsx)(c.Table,{data:i})]})},k=e=>{const{onComplete:t}=e,s=n(e=>e.stack.name),r=(0,f.Iz)(s),i=l.useCallback(e=>{r(e["class-name"],e["class-desc"]).then(e=>{console.log("ClassForm.onSubmit - result",e),e&&t&&t()})},[s,t]);return(0,a.jsxs)(c.Form,{onSubmit:i,children:[(0,a.jsx)(c.TextInput,{name:"class-name",id:"class-name",placeholder:"Movies",label:"Name"},"class-name"),(0,a.jsx)(c.TextInput,{name:"class-desc",id:"class-desc",placeholder:"A collection of 90's movies",label:"Description"},"class-desc")]})},v=()=>{const e=i(),t=n(e=>e.stack.name),{loading:s,error:r,classList:o}=((0,l.useCallback)(()=>{e((0,d.ri)(!0))},[e]),(0,l.useCallback)(()=>{e(g(!0))},[e]),(0,f.Oo)(t)),{Modal:u,open:h,close:m}=(0,c.useModal)({areaId:"root"}),p=l.useMemo(()=>o.length?(0,a.jsx)(c.List,{header:(0,a.jsx)(c.ActionBar,{items:[{position:"right",key:"btn-class-creation-open",item:(0,a.jsx)(c.Button,{onClick:h,type:"primary",iconName:"plus",children:"New class"})}]}),view:"list",pageSize:5,showPageCtrl:!0,type:"raw",children:o.map(e=>(0,a.jsx)(w,{name:e.name,description:e.description,attributes:Object.values(e.getAttributes())}))}):(0,a.jsx)("span",{children:"Loading"}),[s,o,r,h]);return(0,a.jsxs)("main",{className:"view-dashboard",children:[(0,a.jsx)(u,{title:"Create new class",footer:(0,a.jsx)(c.ActionBar,{items:[{position:"right",key:"btn-class-creation-close",item:(0,a.jsx)(c.Button,{type:"default",onClick:m,iconName:"close",children:"Cancel"})}]}),children:(0,a.jsx)(k,{onComplete:m})}),(0,a.jsx)(c.ActionBar,{items:[{item:(0,a.jsx)("h2",{children:"Classes"}),key:"body-title",position:"left"}]}),(0,a.jsx)("div",{className:"view-dash-classes-container",children:p})]})};var x=s(87271);const j=e=>{const{classObj:t,closeModal:s,model:r,mode:i="read"}=e,{name:n,type:o,description:d,config:u}=r,h=l.useMemo(()=>{const e=[(0,a.jsx)(c.TextInput,{disabled:"read"===i,value:d,name:"description",label:"Description"},"description")],t=Object.entries(u).map((e,t)=>{switch(e[0]){case"encrypted":return(0,a.jsx)(c.Toggle,{disabled:"read"==i,name:"encrypted",checked:e[1],label:"Encrypted"},"encrypted");case"mandatory":return(0,a.jsx)(c.Toggle,{disabled:"read"==i,name:"mandatory",checked:e[1],label:"Mandatory"},"mandatory");case"primaryKey":return(0,a.jsx)(c.Toggle,{disabled:"read"==i,name:"primaryKey",checked:e[1],label:"Primary key"},"primaryKey");case"maxLength":return(0,a.jsx)(c.NumberInput,{disabled:"read"==i,name:"maxLength",value:e[1],label:"Max length"},"maxLength");case"max":return(0,a.jsx)(c.NumberInput,{disabled:"read"==i,name:"max",value:e[1],label:"Max"},"max");case"min":return(0,a.jsx)(c.NumberInput,{disabled:"read"==i,name:"min",value:e[1],label:"Min"},"min");case"precision":return(0,a.jsx)(c.NumberInput,{disabled:"read"==i,name:"min",value:e[1],label:"Precision"},"precision");default:return(0,a.jsx)(a.Fragment,{})}});return e.push(...t),e},[u,i]),m=l.useCallback(e=>{if(t){console.log("updateAttr",e);const a=e.description;delete e.description;const r=new x.nW(t,n,o,a,Object.assign({},e));t.modifyAttribute(n,r).then(e=>{}).finally(()=>{s&&s()})}},[s,i,n,o,t]);return(0,a.jsx)(c.Form,{style:{flex:1},onSubmit:"write"===i?m:void 0,children:h})},C=e=>{const{classObj:t,closeModal:s}=e,[r,i]=l.useState(!1),n=(()=>{const[e,t]=l.useState(),s=l.useCallback(e=>{t(e||void 0)},[]),r=l.useMemo(()=>(e=>{const t=[];switch(t.push((0,a.jsx)(c.TextInput,{gridPlacement:"1",id:"name",name:"name",label:"Name",required:!0,placeholder:"Attribute name"},"name")),t.push((0,a.jsx)(c.TextInput,{gridPlacement:"1",id:"description",name:"description",label:"Description",required:!0,placeholder:"Explain what it represent"},"description")),t.push((0,a.jsx)(c.Toggle,{gridPlacement:"2",id:"mandatory",name:"mandatory",checked:!1,label:"Mandatory"},"mandatory")),t.push((0,a.jsx)(c.Toggle,{gridPlacement:"2",id:"primaryKey",name:"primaryKey",checked:!1,label:"Primary key"},"primaryKey")),t.push((0,a.jsx)(c.Toggle,{gridPlacement:"2",id:"isArray",name:"isArray",checked:!1,label:"Array"},"isArray")),e){case"string":t.push((0,a.jsx)(c.NumberInput,{gridPlacement:"3",name:"maxLength",id:"maxLength",value:50,label:"Max length."},"maxLength")),t.push((0,a.jsx)(c.NumberInput,{gridPlacement:"3",name:"encrypted",id:"encrypted",value:50,label:"Encrypted"},"encrypted")),t.push((0,a.jsx)(c.TextInput,{gridPlacement:"3",name:"defaultValue",id:"defaultValue",placeholder:"",label:"Default value"},"defaultValue"));break;case"boolean":t.push((0,a.jsx)(c.Toggle,{gridPlacement:"3",name:"defaultValue",id:"defaultValue",checked:!1,label:"Default value"},"defaultValue"));break;case"integer":case"decimal":t.push((0,a.jsx)(c.NumberInput,{gridPlacement:"3",name:"max",id:"max",label:"Max value"},"max")),t.push((0,a.jsx)(c.NumberInput,{gridPlacement:"3",name:"min",id:"maxLength",label:"Min value"},"min")),t.push((0,a.jsx)(c.NumberInput,{gridPlacement:"3",name:"defaultValue",id:"defaultValue",label:"Default value"},"defaultValue"));break;default:(0,a.jsx)(a.Fragment,{})}return t})(e),[e]);return[(0,a.jsx)(c.Select,{gridPlacement:"1",required:!0,name:"type",id:"type",options:[{value:"string",element:"String"},{value:"boolean",element:"Boolean"},{value:"integer",element:"Integer"},{value:"decimal",element:"Decimal"},{value:"foreign_key",element:"Foreign key"}],placeholder:"Choose",label:"Attribute type",onChange:s}),...r]})(),o=l.useCallback(e=>{const a={};e.mandatory&&(a.mandatory=e.mandatory),e.primaryKey&&(a.primaryKey=e.primaryKey),e.isArray&&(a.isArray=e.isArray),e.defaultValue&&(a.defaultValue=e.defaultValue),e.encrypted&&(a.encrypted=e.encrypted),e.format&&(a.format=e.format),e.maxLength&&(a.maxLength=e.maxLength),e.max&&(a.max=e.max),e.min&&(a.min=e.min),e.precision&&(a.precision=e.precision),e.targetClass&&(a.targetClass=e.targetClass);const r=new x.nW(t,e.name,e.type,e.description,a);t.addAttribute(r).then(e=>{console.log("createAttribute - Result",{result:e})}).finally(()=>{i(!1),s&&s()}),i(!0)},[s,t]);return(0,a.jsx)(c.Form,{gridGap:"1rem 0.5rem",gridTemplate:{cols:"1fr 1fr 1fr"},onSubmit:o,children:n})},A=e=>{const{classObj:t,model:s}=e,{name:r,type:i,config:n}=l.useMemo(()=>s,[s]),[o,d]=l.useState("read"),u=l.useCallback(e=>{["read","write"].includes(e)&&d(e)},[d]),{Modal:h,open:m,close:g}=(0,c.useModal)({areaId:"root"}),{Modal:p,open:y,close:f}=(0,c.useModal)({areaId:"root"}),b=l.useCallback(()=>{console.log(`Deleting attribute '${r}'`),t.removeAttribute(r).then(e=>{console.log("delete attribute result in new classObj",{classObj:t}),f()})},[t,r]);return(0,a.jsxs)(c.Card,{className:"list-item-attribute",children:[(0,a.jsx)(h,{title:`Attribute: ${r}`,footer:(0,a.jsx)(c.ActionBar,{items:[{position:"right",key:"btn-del-attr",item:(0,a.jsx)(c.Button,{type:"default",onClick:g,iconName:"close",children:"Cancel"})},{item:(0,a.jsx)(c.Select,{placeholder:"Mode",options:[{value:"read",element:"View",selected:"read"==o},{value:"write",element:"Edit",selected:"read"!=o}],onChange:e=>u(e)}),position:"left",key:"mode-selector"},{position:"left",key:"btn-cancel-edit-attr",item:(0,a.jsx)(c.Button,{type:"primary",onClick:y,accent:"#f5474c",iconName:"trash",children:"Delete"})}]}),children:(0,a.jsx)(j,{classObj:t,closeModal:g,mode:o,model:s})}),(0,a.jsx)(p,{title:"Confirmation",footer:(0,a.jsx)(c.ActionBar,{items:[{position:"right",key:"btn-cancel-del",item:(0,a.jsx)(c.Button,{onClick:f,type:"primary",iconName:"close",children:"Cancel"})},{position:"right",key:"btn-confirm-del",item:(0,a.jsx)(c.Button,{onClick:b,iconName:"check",children:"Confirm"})}]}),children:"Do you wish to delete this attribute?"}),(0,a.jsxs)(c.Accordion,{header:(0,a.jsx)(c.ActionBar,{items:[{position:"left",key:"label-attr",item:(0,a.jsx)("span",{children:r})},{position:"right",key:"btn-edit-attr",item:(0,a.jsx)(c.Button,{onClick:m,className:"btn-edit-attr",iconName:"external-link",type:"primary"})},{position:"right",key:"btn-del-attr",item:(0,a.jsx)(c.Button,{onClick:y,accent:"#f5474c",className:"btn-del-attr",iconName:"trash",type:"text"})}]}),children:[(0,a.jsx)("span",{children:i}),(0,a.jsx)(j,{model:s})]})]})};var D=s(44358);s(45649),s(35921),s(54193),s(36121),s(99885),s(49745),s(34878);const S=e=>{const{closeModal:t}=e,[s,r]=l.useState(!1),i=l.useRef(),n=l.useRef(),o=l.useCallback(e=>{i.current||e&&(i.current=e,r(!0))},[]),d=l.useCallback(e=>{var s;const a=null===(s=n.current)||void 0===s?void 0:s.getValue();console.log("Create trigger",{data:e,content:a}),t&&t()},[]),u=l.useCallback(e=>!!new RegExp(/^[A-Za-z]*$/gm).test(e)||"Must be without spaces, no special characters and cannot start with a number.",[]);return l.useEffect(()=>{s&&i.current&&(n.current=D.editor.create(i.current,{value:'document["startDate"] = Date.now();\nreturn document;',language:"javascript",automaticLayout:!0}))},[s]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(c.Form,{gridGap:"1rem 0.5rem",gridTemplate:{cols:"1fr"},onSubmit:d,children:[(0,a.jsx)(c.TextInput,{gridPlacement:{row:"1"},required:!0,name:"name",id:"name",validator:u,placeholder:"AutoProperty",label:"Name"}),(0,a.jsx)(c.Select,{gridPlacement:{row:"2"},required:!0,name:"order",id:"order",options:[{value:"before",element:"BEFORE",selected:!0},{value:"after",element:"AFTER"}],label:"Execution order"})]}),(0,a.jsx)("div",{style:{minWidth:"30rem",minHeight:"10rem"},ref:o})]})},M=e=>{const{classObj:t}=e,{name:s,description:r,type:i}=t,n=l.useMemo(()=>t.buildSchema(),[t]),o=l.useMemo(()=>n?(console.log("attributePanels",{schema:n}),Object.values(n).map((e,s)=>(0,a.jsx)(A,{classObj:t,model:e},s))):[],[t,n]),{Modal:d,open:u,close:h}=(0,c.useModal)({areaId:"root"}),{Modal:m,open:g,close:p}=(0,c.useModal)({areaId:"root"}),y=l.useCallback(()=>{window.open("https://onyx-og.github.io/docstack/docs","_blank")},[]);return(0,a.jsxs)("section",{style:{padding:"2rem 1rem"},className:"panel-class-model",children:[(0,a.jsx)(c.Text,{type:"heading",level:2,children:s}),(0,a.jsx)(c.Text,{type:"body",children:r}),(0,a.jsx)(c.Text,{type:"body",children:i}),(0,a.jsx)(d,{title:"New attribute",footer:(0,a.jsx)(c.ActionBar,{items:[{position:"left",key:"btn-attr-creation-close",item:(0,a.jsx)(c.Button,{type:"default",onClick:h,iconName:"close",children:"Cancel"})}]}),children:(0,a.jsx)(C,{classObj:t,closeModal:h})}),(0,a.jsx)(m,{title:"New trigger",footer:(0,a.jsx)(c.ActionBar,{items:[{position:"left",key:"btn-trigg-creation-close",item:(0,a.jsx)(c.Button,{type:"default",onClick:p,iconName:"close",children:"Cancel"})},{position:"right",key:"btn-trigg-creation-help",item:(0,a.jsx)(c.Button,{type:"primary",onClick:y,iconName:"question"})}]}),children:(0,a.jsx)(S,{closeModal:p})}),(0,a.jsx)(c.List,{header:(0,a.jsx)(c.ActionBar,{items:[{position:"left",key:"list-title-attr",item:(0,a.jsx)("h3",{children:"Attributes"})},{position:"right",key:"btn-add-attr",item:(0,a.jsx)(c.Button,{type:"primary",onClick:u,iconName:"plus",children:"New attribute"})}]}),type:"raw",view:"list",children:o}),(0,a.jsxs)(c.List,{header:(0,a.jsx)(c.ActionBar,{items:[{position:"left",key:"list-title-trigg",item:(0,a.jsx)("h3",{children:"Triggers"})},{position:"right",key:"btn-add-trigg",item:(0,a.jsx)(c.Button,{type:"primary",onClick:g,iconName:"plus",children:"New trigger"})}]}),type:"raw",view:"list",children:[(0,a.jsx)("div",{children:"Placeholder"}),(0,a.jsx)("div",{children:"Such empty"})]})]})},I=l.forwardRef((e,t)=>{const{name:s,type:r,config:i,value:n,defaultMode:o="read",allowToggleMode:d=!1}=e,[u,h]=l.useState(o),m=l.useCallback(()=>{h("read"==u?"write":"read")},[u]),g=l.useMemo(()=>{if(d)return(0,a.jsx)(c.Button,{onClick:m,iconName:"write"==u?"eye":"pencil",type:"text"})},[u,d]);switch(r){case"string":return(0,a.jsx)(c.TextInput,{required:i.mandatory,ref:t,after:g,type:"default",htmlType:"text",disabled:"read"==u,name:s,label:s,value:n},s);case"boolean":return(0,a.jsx)(c.Toggle,{type:"switch",name:s,label:s,checked:n});default:throw new Error(`Unexpected attribute field type '${r}'`)}}),P=e=>{const{model:t,mode:s="read",doc:r,onSubmission:i}=e,{schema:o=[],name:d}=t,[u,h]=l.useState(s),m=n(e=>e.stack.name),g=l.useCallback(e=>{["read","read/write"].includes(e)&&h(e)},[]),{Modal:p,open:y,close:b}=(0,c.useModal)({areaId:"root"}),{loading:w,error:k,classObj:v}=(0,f.me)(m,t.name),x=l.useCallback(e=>{v&&(console.log(`submitDoc - id: ${null==r?void 0:r._id}`),v.addOrUpdateCard(e,null==r?void 0:r._id)),i&&i(e)},[r,v,i]),j=l.useMemo(()=>{let e=[];for(const t of Object.values(o))e.push((0,l.createElement)(I,Object.assign({defaultMode:"read/write"!=u?u:"write",allowToggleMode:"read/write"==u},t,{value:null==r?void 0:r[t.name],key:t.name})));return e},[o,r,u]),C=l.useCallback(()=>{if(!v||!r)throw v?new Error("Missing document to delete"):new Error("Missing class instance. Check logs");v.deleteCard(r._id).then(e=>{e&&i&&i({deleted:!0})})},[r,v,i]),A=l.useMemo(()=>{const e=[];return r&&e.push({position:"left",key:"btn-doc-del",item:(0,a.jsx)(c.Button,{iconName:"trash",type:"primary",onClick:y})}),e.push({item:(0,a.jsx)(c.Select,{placeholder:"Mode",options:[{value:"read",element:"View",selected:"read"==u},{value:"read/write",element:"Edit",selected:"read"!=u}],onChange:e=>g(e)}),position:"left",key:"mode-selector"}),e},[r,u,y]);return(0,a.jsxs)("div",{children:[(0,a.jsx)(p,{title:"Confirmation",footer:(0,a.jsx)(c.ActionBar,{items:[{position:"right",key:"btn-cancel-del",item:(0,a.jsx)(c.Button,{onClick:b,type:"primary",iconName:"close",children:"Cancel"})},{position:"right",key:"btn-confirm-del",item:(0,a.jsx)(c.Button,{onClick:C,iconName:"check",children:"Confirm"})}]}),children:"Do you wish to delete this document?"}),(0,a.jsx)(c.Form,{className:"form-class-doc",onSubmit:x,children:j}),(0,a.jsx)(c.ActionBar,{items:A})]})},N=e=>{const{className:t,model:s}=e,r=n(e=>e.stack.name),{loading:i,error:o,docs:d}=(0,f.Xm)(r,t),[u,h]=l.useState("view"),{Modal:m,open:g,close:p}=(0,c.useModal)({areaId:"root"}),[y,b]=l.useState(),w=l.useCallback(e=>{["view","edit"].includes(e)&&h(e)},[]),k=l.useMemo(()=>{let e=[],t={};return d.length?e.push(...d):s&&(Object.values(s.schema).forEach(e=>{t[e.name]=void 0}),e.push(t)),e},[s,d]),v=l.useCallback(e=>{const t=k[e];b(t),g()},[k]),x=l.useCallback(()=>{b(void 0),g()},[k]),j=l.useCallback(e=>{const{data:t,coords:s,mode:r}=e,i=`${s?s.concat():null}`,n=`doc-cell mode-${u}`;return(0,a.jsx)("td",{onClick:()=>{"edit"==u&&v(Number(s[0]))},className:n,onDoubleClick:()=>{"view"==u&&v(Number(s[0]))},children:null==t?void 0:t.toString()},i)},[u,v]),C=l.useMemo(()=>{if(k&&k.length)return(0,a.jsx)(c.Table,{cellRenderer:j,data:[...k]})},[k,j]);return(0,a.jsxs)("section",{style:{padding:"2rem 1rem"},children:[(0,a.jsx)(c.ActionBar,{items:[{position:"left",key:"target-selector",item:(0,a.jsx)(c.Select,{placeholder:"Mode",options:[{value:"view",element:"View",selected:"view"==u},{value:"edit",element:"Edit",selected:"edit"==u}],onChange:e=>w(e)})},{position:"right",key:"btn-add-doc",item:(0,a.jsx)(c.Button,{type:"primary",onClick:x,iconName:"plus-square"})}]}),(0,a.jsx)(m,{title:"Document",children:(null==s?void 0:s.schema)?(0,a.jsx)(P,{doc:y,mode:"edit"==u?"read/write":"read",model:s,onSubmission:p}):(0,a.jsx)("span",{children:"Check logs"})}),C]})},E=()=>{const{className:e}=(0,o.g)(),t=n(e=>e.stack.name),{loading:s,error:r,classObj:i}=(0,f.me)(t,e),d=l.useCallback(async()=>{if(i&&"User"==i.name){const e=await i.validate({username:"test",password:"test"});console.log("validationTest - result",e)}},[s,r]);l.useEffect(()=>{i&&d()},[d]);const[u,h]=l.useState("model"),m=l.useMemo(()=>{if("model"!=u){if("docs"==u)return(0,a.jsx)(N,{className:e,model:null==i?void 0:i.getModel()});throw new Error(`Unexpected panel value "${u}"`)}return i?(0,a.jsx)(M,{classObj:i}):s?(0,a.jsx)("span",{children:"Loading"}):r?(0,a.jsx)("span",{children:r}):void 0},[s,r,i,u]);return(0,a.jsxs)("main",{className:"view-class",children:[(0,a.jsx)(c.Tabs,{onChange:h,tabsClass:"view-class-tabs-header",data:[{name:"model",label:"Model"},{name:"docs",label:"Documents"}]}),m]})},$=()=>{const e=l.useContext(f.MI),t=(0,o.Zp)(),s=l.useCallback(()=>{if(!e)throw new Error("reset must be used whithin DockStackProvider");e.reset(),t("/"),t(0)},[]);return(0,a.jsx)("div",{children:(0,a.jsx)(c.Button,{type:"primary",onClick:s,children:"Reset"})})};s(94093);const O=()=>{const e=n(e=>e.auth.isAuthenticated),t=(n(e=>e.auth.isAnonymous),(0,o.Zp)()),r=i(),u=(0,o.zy)(),{Modal:h,state:m,open:g}=(0,c.useModal)({areaId:"root"}),p=l.useCallback(()=>{if(!e)throw new Error("Must be authenticated to logout");r((0,d.ri)(!0))},[r]),y=l.useCallback(()=>{t(-1)},[t]),f=l.useMemo(()=>{let e=[];return"/"==u.pathname?e.push({item:(0,a.jsx)("div",{style:{height:"40px",width:"40px",background:`url("${s(79334)}")`,backgroundSize:"contain"}}),key:"nav-logo",position:"left"}):e.push({item:(0,a.jsx)(c.Button,{type:"text",onClick:y,shape:"circle",iconName:"chevron-left"}),key:"btn-back",position:"left"}),e.push({item:(0,a.jsx)(c.Text,{type:"heading",level:1,children:"Dashboard"}),key:"dashboard-title",position:"left"},{item:(0,a.jsx)(c.Button,{type:"text",iconName:"bug",onClick:g}),key:"btn-bug",position:"right"},{item:(0,a.jsx)(c.Button,{type:"primary",onClick:p,children:"Logout"}),key:"btn-logout",position:"right"}),e},[g,p,u]);return(0,a.jsxs)(c.Header,{style:{borderBottom:"var(--color-primary) solid .1rem"},children:[(0,a.jsx)(h,{title:"Debug Panel",children:(0,a.jsx)($,{})}),(0,a.jsx)(c.ActionBar,{items:f})]})},T=()=>{const e=n(e=>e.auth.isAuthenticated),t=n(e=>e.auth.isAnonymous),s=(0,o.Zp)(),r=(0,o.zy)();l.useEffect(()=>{s(e||t?"/":"/login")},[e,t]);const i=l.useMemo(()=>e||t?(0,a.jsx)(O,{}):null,[e,t,r]);return(0,a.jsxs)(a.Fragment,{children:[i,(0,a.jsxs)(o.BV,{children:[(0,a.jsx)(o.qh,{path:"/",element:(0,a.jsx)(v,{})}),(0,a.jsx)(o.qh,{path:"/login",element:(0,a.jsx)(y,{})}),(0,a.jsx)(o.qh,{path:"/class/:className",element:(0,a.jsx)(E,{})})]})]})}},27768:(e,t,s)=>{"use strict";s.d(t,{A:()=>i,S:()=>r});var a=s(50523);const r=(0,a.VP)("stack/setName"),i=(0,a.vy)({name:""},e=>e.addCase(r,(e,t)=>{e.name=t.payload}))},28431:(e,t,s)=>{"use strict";s.d(t,{A:()=>l});var a=s(56563),r=s(86155),i=s.n(r),n=s(57822);s(50766);class o extends(i()){constructor(e){super(e),this.db=new n.A(e.dbName)}async log(e,t){queueMicrotask(()=>{this.emit("logged",e)});const s=await this.db.post({type:"log",log:e});s.ok||console.log("pouchdb-transport - failed to push to pouchdb",s),t()}}const c=o,l=(e="log")=>(0,a.createLogger)({transports:[new c({dbName:e}),new a.transports.Console]})},31297:(e,t,s)=>{"use strict";e.exports=s.p+"4f59e8c4dca34ac26cc2.jpg"},35295:()=>{},43820:(e,t,s)=>{"use strict";s.d(t,{Ay:()=>c,iD:()=>n,ri:()=>o,lp:()=>i});var a=s(50523);const r=async e=>{const t=await(async e=>{const t=e.replace("-----BEGIN PUBLIC KEY-----","").replace("-----END PUBLIC KEY-----","").replace(/\n/g,""),s=(e=>{const t=new ArrayBuffer(e.length),s=new Uint8Array(t);for(let t=0,a=e.length;t<a;t++)s[t]=e.charCodeAt(t);return t})(window.atob(t));return window.crypto.subtle.importKey("spki",s,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"])})('""'),s=await(async(e,t)=>{const s=new TextEncoder;return await window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,s.encode(t))})(t,e);return btoa(String.fromCharCode(...new Uint8Array(s)))},i=(0,a.VP)("skipLogin"),n=(0,a.zD)("login",async(e,t)=>{let s=await(async e=>{const t=await r(e.password);return(await fetch(`${e.serverURL}/login`,{method:"POST",body:JSON.stringify({username:e.username,password:t}),mode:"cors",headers:{"Content-Type":"application/json"}})).json()})(e);return s.success?s:t.rejectWithValue(s)}),o=(0,a.zD)("logout",async(e,t)=>{}),c=(0,a.vy)({isAuthenticated:!1,isAnonymous:!1},e=>{e.addCase(n.fulfilled,(e,t)=>{e.isAuthenticated=!0}).addCase(n.rejected,(e,t)=>{console.error(t.error)}).addCase(o.fulfilled,(e,t)=>{e.isAuthenticated=!1,e.isAnonymous=!1}).addCase(o.rejected,(e,t)=>{console.error(t.error)}).addCase(i,(e,t)=>{e.isAnonymous=!0})})},47618:(e,t,s)=>{"use strict";s.r(t);const a=(0,s(28431).A)().child({module:"dataModel"});a.info("Worker successfully registered");const r=[];let i=!1;const n=async()=>{if(a.child({method:"processQueue"}).info("Started to process model worker queue"),i||0===r.length)return;i=!0;const e=r.shift();if(e){const{command:t,payload:s}=e;i=!1,n()}};self.onmessage=e=>{e.data.command&&(r.push(e.data),n())},self.onmessageerror=e=>{a.error("Got error",{event:e})}},48241:e=>{"use strict";e.exports=JSON.parse('{"version":"0.0.1","docs":[{"_id":"~User","active":true,"name":"User","description":"A user class for secure login","type":"class","schema":{"username":{"name":"username","type":"string","config":{"primaryKey":true,"maxLength":50,"mandatory":true,"isArray":false}},"password":{"name":"password","type":"string","config":{"maxLength":50,"mandatory":true,"isArray":false}},"email":{"name":"email","type":"string","config":{"maxLength":50,"isArray":false}},"firstName":{"name":"firstName","type":"string","config":{"maxLength":50,"isArray":false}},"lastName":{"name":"lastName","type":"string","config":{"maxLength":50,"isArray":false}}}},{"_id":"~UserSession","name":"UserSession","active":true,"description":"Tracks user sessions","type":"class","schema":{"username":{"name":"username","type":"string","config":{"maxLength":50,"isArray":false,"primaryKey":true,"mandatory":true}},"sessionId":{"name":"sessionId","type":"string","config":{"maxLength":200,"primaryKey":true,"isArray":false,"mandatory":true}},"sessionStart":{"name":"sessionStart","type":"string","config":{"maxLength":100,"isArray":false,"mandatory":true}},"sessionStatus":{"name":"sessionStatus","type":"string","config":{"maxLength":100,"isArray":false,"mandatory":true}},"sessionEnd":{"name":"sessionEnd","type":"string","config":{"maxLength":100,"isArray":false,"mandatory":false}}}}]}')},49914:()=>{},51027:()=>{},59135:(e,t,s)=>{var a={"./editorBaseApi":[37970],"./editorBaseApi.js":[37970],"./editorSimpleWorker":[68757],"./editorSimpleWorker.js":[68757],"./editorWorker":[22143],"./editorWorker.js":[22143],"./editorWorkerHost":[70869],"./editorWorkerHost.js":[70869],"./findSectionHeaders":[97716],"./findSectionHeaders.js":[97716],"./getIconClasses":[45555,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./getIconClasses.js":[45555,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./languageFeatureDebounce":[26973],"./languageFeatureDebounce.js":[26973],"./languageFeatures":[33653],"./languageFeatures.js":[33653],"./languageFeaturesService":[43266],"./languageFeaturesService.js":[43266],"./languageService":[22155],"./languageService.js":[22155],"./languagesAssociations":[25709],"./languagesAssociations.js":[25709],"./languagesRegistry":[35074],"./languagesRegistry.js":[35074],"./markerDecorations":[86259],"./markerDecorations.js":[86259],"./markerDecorationsService":[72524],"./markerDecorationsService.js":[72524],"./model":[16911],"./model.js":[16911],"./modelService":[91320],"./modelService.js":[91320],"./resolverService":[77768],"./resolverService.js":[77768],"./semanticTokensDto":[7029,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./semanticTokensDto.js":[7029,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./semanticTokensProviderStyling":[36913],"./semanticTokensProviderStyling.js":[36913],"./semanticTokensStyling":[74566],"./semanticTokensStyling.js":[74566],"./semanticTokensStylingService":[28843],"./semanticTokensStylingService.js":[28843],"./textModelSync/textModelSync.impl":[47177],"./textModelSync/textModelSync.impl.js":[47177],"./textModelSync/textModelSync.protocol":[37619,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./textModelSync/textModelSync.protocol.js":[37619,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./textResourceConfiguration":[93533],"./textResourceConfiguration.js":[93533],"./treeSitterParserService":[47105],"./treeSitterParserService.js":[47105],"./treeViewsDnd":[29740,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./treeViewsDnd.js":[29740,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./treeViewsDndService":[95621,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./treeViewsDndService.js":[95621,997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],"./unicodeTextModelHighlighter":[14818],"./unicodeTextModelHighlighter.js":[14818]};function r(e){if(!s.o(a,e))return Promise.resolve().then(()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t});var t=a[e],r=t[0];return Promise.all(t.slice(1).map(s.e)).then(()=>s(r))}r.keys=()=>Object.keys(a),r.id=59135,e.exports=r},62080:()=>{},62627:()=>{},69256:()=>{},78314:()=>{},78675:()=>{},79334:e=>{"use strict";e.exports="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIxNSAxNSA3MCA3MCI+CgogIDwhLS0gQm90dG9tIGRvY3VtZW50IC0tPgogIDxyZWN0IHg9IjIwIiB5PSIzMCIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iNCIgcnk9IjQiIGZpbGw9IiNmMGYwZjAiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIzIi8+CgogIDwhLS0gTWlkZGxlIGRvY3VtZW50IC0tPgogIDxyZWN0IHg9IjI1IiB5PSIyNSIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iNCIgcnk9IjQiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIzIi8+CgogIDwhLS0gVG9wIGRvY3VtZW50IC0tPgogIDxyZWN0IHg9IjMwIiB5PSIyMCIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iNCIgcnk9IjQiIGZpbGw9IiNlOGU4ZTgiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIzIi8+Cgo8L3N2Zz4="},81463:(e,t,s)=>{var a={"./patch-000.json":48241};function r(e){var t=i(e);return s(t)}function i(e){if(!s.o(a,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return a[e]}r.keys=function(){return Object.keys(a)},r.resolve=i,e.exports=r,r.id=81463},85288:(e,t,s)=>{"use strict";s.d(t,{A:()=>i});var a=s(50523);const r=(0,a.VP)("setQuery"),i=(0,a.vy)({query:""},e=>{e.addCase(r,(e,t)=>{e.query=t.payload})})},86973:()=>{},87271:(e,t,s)=>{"use strict";s.d(t,{nW:()=>b,Xs:()=>x,jg:()=>B});var a=s(28431),r=s(57822),i=s(66358);class n extends EventTarget{constructor(){super(),this.attributes={},this.schema={},this.schemaZOD=i.object({}),this.state="idle",this.triggers=[]}}const o=n,c=class{constructor(e=null,t,s,a){this.class=null}};class l extends EventTarget{constructor(){super(...arguments),this.cache={},this.listeners=[],this.modelWorker=null}}l.appVersion="0.0.1";const d=l,u=class{constructor(){}},h=["string","number","integer","reference","boolean"],m=e=>!!e.hasOwnProperty("type"),g=e=>!(!e.hasOwnProperty("type")||"class"!==e.type);var p,y=s(85924);class f extends c{constructor(e=null,t,s,a,r){super(e,t,s,r),this.field=y.Ay$.any(),this.setField=()=>{const{name:e,type:t,config:s}=this.model;let a;switch(t){case"string":a=y.Ay$.string(),void 0!==s.maxLength&&(a=a.max(s.maxLength));break;case"integer":a=y.Ay$.number(),"number"==typeof s.min&&(a=a.min(s.min)),"number"==typeof s.max&&(a=a.max(s.max));break;case"decimal":if(a=y.Ay$.number(),"number"==typeof s.min&&(a=a.min(s.min)),"number"==typeof s.max&&(a=a.max(s.max)),"number"==typeof s.precision&&s.precision>=0){const e=e=>{if("number"!=typeof e)return!0;const t=e.toString().split(".")[1];return(t?t.length:0)<=s.precision};a=a.refine(e,`Number cannot have more than ${s.precision} decimals.`)}break;case"boolean":a=y.Ay$.boolean();break;case"foreign_key":if(!s.targetClass)throw new Error(`Attribute '${e}' of type 'foreign_key' is missing a 'targetClass' in its config.`);const r=s.targetClass;a=y.Ay$.string().refine(async e=>{const t=Array.isArray(e)?e:[e];if(0===t.length)return!0;try{if(this.class){const e=this.class.getStack();if(e){const s=t.map(t=>e.db.get(t));return await Promise.all(s),!0}throw new Error("Missing stack connection")}throw new Error("Missing class parentship")}catch(e){if(404===e.status)return!1;throw e}},{message:`One or more documents not found in class '${r}'.`});break;default:throw new Error(`Unsupported schema type: '${t}' for field '${e}'`)}s.defaultValue&&(a=a.default(s.defaultValue)),!0!==s.mandatory&&(a=a.optional()),!0===s.isArray&&(a=y.Ay$.array(a)),this.field=a},this.isPrimaryKey=()=>!!this.getModel().config.primaryKey,this.isMandatory=()=>!!this.model.config.mandatory,this.getModel=()=>this.model,this.getClass=()=>{if(this.class)return this.class;throw Error("Missing class configuration for this attribute")},this.validate=async e=>this.field.safeParseAsync(e),this.setModel=e=>{let t=this.getModel();e=Object.assign(t||{},e),this.model=e,this.defaultValue=e.config.defaultValue},this.getType=e=>{if(this.checkTypeValidity(e))return e;throw Error("Invalid attribute type: "+e)},this.getEmpty=()=>({[this.name]:this.field.parse(void 0)||null}),this.getName=()=>this.name,this.checkTypeValidity=e=>{let t=!1;return h.includes(e)&&(t=!0),t},this.getTypeConf=(e,t)=>{switch(e){case"decimal":t=Object.assign({max:null,min:null,precision:null,isArray:!1},t);break;case"integer":t=Object.assign({max:null,min:null,isArray:!1},t);break;case"string":t=Object.assign({maxLength:50,isArray:!1},t);break;default:throw new Error("Unexpected type: "+e)}return t},this.name=t,this.description=a,this.setModel({name:this.name,description:this.description,type:this.getType(s),config:this.getTypeConf(s,r)||{}}),this.setField(),this.class=e}static async create(e,t,s,a,r){const i=new p(e,t,s,a,r);return await p.build(i),i}}p=f,f.build=async e=>{let t=e.getClass();if(t.getStack())return await t.addAttribute(e),e;throw new Error("Missing db configuration")};const b=f;class w extends u{constructor(e,t){if(super(),this.execute=async e=>{const t=this.classObj?this.classObj.getStack():void 0,s=await this.run(e,this.classObj,t);return void 0===s?(console.warn(`Trigger '${this.model.name}' did not return a document. Returning the original document.`),e):s},this.executeLimited=async e=>{const t=await this.run(e);return void 0===t?(console.warn(`Trigger '${this.model.name}' did not return a document. Returning the original document.`),e):t},this.model=e,this.name=e.name,this.order=e.order,this.classObj=t,"string"!=typeof e.run)throw new Error("Trigger model's 'run' field must be a string representation of a function.");try{this.run=new Function("document","classObj","stack",`\n                "use strict";\n                // The developer's code is placed here.\n                return (async () => {\n                    ${e.run}\n                })();\n            `)}catch(t){throw new Error(`Failed to hydrate trigger '${e.name}': ${t}`)}}}var k;class v extends o{constructor(){super(),this.attributes={},this.schema={},this.schemaZOD=i.object({}),this.state="idle",this.logger=(0,a.A)().child({module:"class",className:this.name}),this.triggers=[],this.build=()=>new Promise(async(e,t)=>{let s=this.getStack();if(s){let a=await s.addClass(this);a?(this.setModel(a),this.logger.info("build - classModel",{classModel:a}),this.setId(a._id),e(this)):t("unable to get classModel. Check logs")}else t("Missing db configuration")}),this.init=(e,t,s,a,r={})=>{this.name=t,this.id=t,this.description=a,this.type=s,this.setModel({type:s,_id:t,active:!0,name:t,description:a,schema:r,triggers:[]}),e&&(this.stack=e)},this.uniqueCheck=async e=>{const t=this.logger.child({method:"uniqueCheck",args:{doc:e}}),s=await this.getByPrimaryKeys(e);return null==s||s._id==e._id?(t.info("No duplicate found for doc"),!0):(t.info("Duplicate found for doc",{duplicate:s}),!1)},this.bulkUniqueCheck=async e=>{var t;const s=this.logger.child({method:"bulkUniqueCheck",args:{pKs:e}}),a=await(null===(t=this.stack)||void 0===t?void 0:t.addDesignDocumentPKs(this.name,e,!0));if(s.info(`Created temporary design document '${a}'`),!this.stack||!a)return s.error("Was unable to create temporary design document to group by"),!1;try{if((await this.stack.db.query(`${a}/by_pKeys`,{group:!0,reduce:"_count"})).rows.some(e=>e.value>1)){s.error("Schema change invalid: new duplicates found.");const e=await this.stack.db.get(a);return await this.stack.db.remove(e),!1}{s.info("Bulk unique check completed: no new duplicates found");const e=await this.stack.db.get(a);return await this.stack.db.remove(e),!0}}catch(e){console.error("Error during schema validation:",e);try{const e=await this.stack.db.get(a);await this.stack.db.remove(e)}catch(e){}return!1}},this.validate=async e=>{const t=this.logger.child({method:"validate"}),s=await this.schemaZOD.safeParseAsync(e);return t.debug("Got result",{result:s}),!!s.success},this.setId=e=>{this.id=e},this.getName=()=>this.name,this.getStack=()=>this.stack,this.getDescription=()=>this.description,this.getType=()=>this.type,this.getId=()=>this.id,this.buildSchema=()=>{let e={};return Object.entries(this.attributes).forEach(t=>{e[t[0]]=t[1].model}),e},this.getModel=()=>{let e=[];for(const t of this.triggers)e.push(t.model);return{_id:this.getName(),name:this.getName(),description:this.getDescription(),type:this.getType(),schema:this.buildSchema(),triggers:e,active:!0,_rev:this.model?this.model._rev:"",createTimestamp:this.model?this.model.createTimestamp:void 0}},this.setModel=e=>{this.logger.info("setModel - got incoming model",{model:e});let t=this.getModel();if((e=Object.assign(t,e)).schema){this.attributes={},this.schemaZOD=i.object({});for(const[t,s]of Object.entries(e.schema)){let e=new b(this,s.name,s.type,s.description,s.config);this.attributes[s.name]=e,this.schemaZOD=this.schemaZOD.extend({[s.name]:e.field})}}if(e.triggers)for(const t of e.triggers){let e=new w(t,this);this.triggers.push(e)}this.name=e.name,this.description=e.description,this.model=e,this.logger.info("setModel - model after processing",{model:e})},this.getPrimaryKeys=()=>Object.values(this.attributes).filter(e=>e.isPrimaryKey()).map(e=>e.getName()),this.getAttributes=(...e)=>{let t={};for(const s of Object.values(this.attributes))if(e.length>0)for(let a of e)null!=a&&s.getName()==a&&(t[s.name]=s);else t[s.name]=s;return t},this.hasAllAttributes=(...e)=>{let t=!1,s=this.getAttributes(...e);for(let a of Object.values(s))if(t=e.includes(a.getName()),!t)break;return t},this.hasAnyAttributes=(...e)=>{let t=!1,s=this.getAttributes(...e);for(let a of Object.values(s))if(t=e.includes(a.getName()),t)break;return t},this.hasAttribute=e=>this.hasAnyAttributes(e),this.addAttribute=async e=>{const t=this.logger.child({method:"addAttribute",args:{attribute:e.name}}),s=e instanceof b?e:new b(this,e.name,e.type,e.description,e.config);try{let e=s.getName();if(this.hasAttribute(e))return t.error("Attribute with name "+e+" already exists within this Class"),this;{t.info("Adding attribute",{name:e,type:s.getModel()}),this.attributes[e]=s;let a=s.getModel();return t.info("Adding attribute to schema",{attributeModel:a}),t.info("Checking for requirements before updating class on db",{stack:null!=this.stack,id:this.id}),this.stack&&this.id?(t.info("Updating class on db"),await this.stack.updateClass(this),this):(t.error("Class not updated on db because of missing stack or id"),this)}}catch(e){return t.error("Falied adding attribute because: ",e),this}},this.modifyAttribute=async(e,t)=>{const s=this.logger.child({method:"modifyAttribute",args:{name:e}}),a=Object.assign({},this.model.schema[e]),r=this.attributes[e],i=t instanceof b?t:new b(this,t.name,t.type,t.description,t.config);try{return s.info("Attempting to change attribute definition."),delete this.model.schema[e],delete this.attributes[e],this.schemaZOD=this.schemaZOD.omit({[e]:!0}),this.addAttribute(i)}catch(t){this.model.schema[e]=a,this.attributes[e]=r,s.error("Failed at removing attribute from class.'")}return this},this.removeAttribute=async e=>{const t=this.logger.child({method:"removeAttribute",args:{name:e}}),s=Object.assign({},this.model.schema[e]),a=this.attributes[e];try{if(t.info("Attempting to remove attribute from class."),delete this.model.schema[e],delete this.attributes[e],this.schemaZOD=this.schemaZOD.omit({[e]:!0}),!this.stack)throw new Error("Missing stack, cannot perform updates.");this.stack.updateClass(this)}catch(r){this.model.schema[e]=s,this.attributes[e]=a,t.error("Failed at removing attribute from class.'")}return this},this.addCard=async e=>await this.stack.createDoc(null,this.getName(),this,e),this.getByPrimaryKeys=async e=>{const t=this.logger.child({method:"getByPrimaryKeys"});let s={},a=this.getPrimaryKeys();if(t.info("Got primary keys",{primaryKeys:a}),a.length){a.reduce((t,s)=>t[s]=e[s],s),t.info("Defined filter",{filter:s});let r=await this.getCards(s,void 0,0,1);return r.length>0?r[0]:(t.info("Did not find any documents with given primary key",{filter:s}),null)}return t.info("Class has no field specified as primary key"),null},this.addOrUpdateCard=async(e,t)=>{const s=this.logger.child({method:"addOrUpdateCard",args:{params:e,cardId:t}});return new Promise(async(a,r)=>{t?(s.info("Provided document's id, performing an update"),a(await this.updateCard(t,e))):(s.info("No document id provided, checking for PKs"),null==await this.getByPrimaryKeys(e)?a(await this.addCard(e)):(s.error("Duplicate card by keys"),r("Duplicate card by keys")))})},this.updateCard=async(e,t)=>new Promise(async(s,a)=>{this.stack?s(await this.stack.createDoc(e,this.getName(),this,t)):(this.logger.info("no stack defined"),s(null))}),this.deleteCard=async e=>{const t=this.logger.child({method:"deleteCard",args:{cardId:e}});return this.stack?await this.stack.deleteDocument(e):(t.error("Stack is not defined"),!1)},this.getCards=async(e,t,s,a)=>{let r=Object.assign(Object.assign({},e),{type:this.name});return this.logger.info("getCards - selector",{selector:r,fields:t,skip:s,limit:a}),(await this.stack.findDocuments(r,t,s,a)).docs},this.addTrigger=async(e,t)=>{const s=this.logger.child({method:"addTrigger"});try{const e=new w(t,this);if(this.triggers.push(e),!this.stack)throw new Error("Stack is not defined. Can't update class");this.setModel(),await this.stack.updateClass(this)}catch(e){s.error(e)}return this},this.removeTrigger=async e=>(this.triggers=this.triggers.filter(t=>t.name!=e),this)}}k=v,v.logger=(0,a.A)().child({module:"class"}),v.get=(e,t,s="class",a,r={})=>{const i=new k;return k.logger.info("Received schema",{schema:r}),i.init(e,t,s,a,r),i.stack.onClassDoc(t).on("change",e=>{console.log("onClassDoc",{change:e});const t=new CustomEvent("doc",{detail:e});i.dispatchEvent(t)}),i},v.create=async(e,t,s="class",a,r={})=>{const i=k.get(e,t,s,a,r);return await i.build(),i},v.buildFromModel=async(e,t)=>(k.logger.info("buildFromModel - Instantiate from model",{classModel:t}),t._rev?k.get(e,t.name,t.type,t.description,t.schema):await k.create(e,t.name,t.type,t.type,t.schema)),v.fetch=async(e,t)=>{let s=await e.getClassModel(t);return s?k.buildFromModel(e,s):null};const x=v,j=e=>{};var C=s(10881),A=s(71558),D=s(93854);const S=async(e,t,s,a)=>{const r=new b(null,t.name,t.type,t.description,t.config);if("add"===e&&(a=Object.assign(Object.assign({},a),r.getEmpty())),"delete"===e)delete a[r.name];else if(!await r.validate(a[r.name]))throw new Error(`Attribute '${s.name}.${r.name}' ${e} fails for current document because of its validation`);if(r.isPrimaryKey()&&!s.bulkUniqueCheck(s.getPrimaryKeys()))throw new Error(`With attribute '${r.name}' ${e} of class '${s.name}', docs fail primary keys check.`);if("delete"!==e&&r.isMandatory()&&null==a[r.name])throw new Error(`Attribute '${s.name}.${r.name}' is mandatory but has no value.`);return a},M=async(e,t,s)=>{const r=(0,a.A)().child({method:"applySchemaDelta"});let i=Object.assign({},e);const n=Object.entries(t);for(const e of n)if(r.debug(`Delta of attribute '${e[0]}'`),Array.isArray(e[1])){if(1===e[1].length){const t=e[1][0];i=await S("add",t,s,i)}if(1===e[1].length){const t=e[1][0];i=await S("change",t,s,i)}if(3===e[1].length){const t=e[1][0];i=await S("delete",t,s,i)}return i}return i},I=(0,a.A)().child({module:"pouchdb"}),P=e=>{const t=A.A.prototype.bulkDocs;return{bulkDocs:async function(s,a,r){const i=I.child({method:"bulkDocs"});"function"==typeof a&&(r=a,a={});const n=()=>r?t.call(this,s,a,r):t.call(this,s,a);let o;o=Array.isArray(s)?s:s.docs;for(const t of o)if(g(t)){i.info("Document is class model, following update propagation procedure.");const s=t._id;try{if(1==(await e.db.get(s,{revs:!0}))._revisions.ids.length)return i.info(`Class '${s}' was just created. Nothing to do.`),n()}catch(e){if("not_found"===e.name)return n()}const a=await e.getClass(s,!0);if(null==a)throw new Error(`Unexpected, can't retrieve class '${s}'`);const r=a.model;i.info("Retrieved documents",{doc:t,previousClassDoc:r});const o=D.Ui(r.schema,t.schema);if(!o)return i.info(`Class '${s}' has no changes on schema.`),n();const c=await a.getCards();if(0===c.length)return i.info(`No documents found for class '${s}' after its update.`),n();const l=await Promise.all(c.map(async e=>await M(e,o,a)));await e.db.bulkDocs(l),i.info("Propagated updates")}else if(m(t)){const s=t.type;try{const a=await e.getClass(s);if(a){const e=a.triggers.filter(e=>"before"===e.order);for(const s of e){const e=await s.execute(t);Object.assign(t,e)}if(!await a.validate(t))throw new Error("Discarded object because object not valid for its Class schema")}}catch(e){return Promise.reject(e)}}return n()}}};var N=s(39907);const E=(0,a.A)().child({module:"stack"}),$={_id:{name:"_id",type:"string",config:{maxLength:100,primaryKey:!0}},type:{name:"type",type:"string",config:{maxLength:100}},createTimestamp:{name:"createTimestamp",type:"integer",config:{min:0}},updateTimestamp:{name:"updateTimestamp",type:"integer",config:{min:0}},description:{name:"description",type:"string",config:{maxLength:1e3}},active:{name:"active",type:"boolean",config:{defaultValue:!0,primaryKey:!0}}},O=Object.assign(Object.assign({},$),{schema:{name:"schema",type:"object",config:{maxLength:1e3,isArray:!0}},parentClass:{name:"parentClass",type:"foreign_key",config:{isArray:!1}}}),T=Object.assign({schema:{name:"schema",type:"object",config:{isArray:!0,defaultValue:[{name:"source",type:"foreign_key",config:{isArray:!1}},{name:"target",type:"foreign_key",config:{isArray:!1}}]}},parentDomain:{name:"parentDomain",type:"foreign_key",config:{isArray:!1}},relation:{name:"relation",type:"string",config:{maxLength:100,isArray:!1}},sourceClass:{name:"sourceClass",type:"foreign_key",config:{isArray:!0}},targetClass:{name:"targetClass",type:"foreign_key",config:{isArray:!0}}},$);class L extends d{constructor(){super(),this.listeners=[],this.modelWorker=null,this.setListeners=()=>{const e=E.child({method:"setListeners"});this.addEventListener("class-model-propagation-pending",this.onClassModelPropagationStart),this.addEventListener("class-model-propagation-complete",this.onClassModelPropagationComplete),e.info("Setting up class model worker"),this.modelWorker=new Worker(s(47618),{type:"module"}),e.info("Setting up class model changes listener");const t=this.onClassModelChanges();this.modelWorker.onmessage=t=>{const{status:s,className:a,message:r}=t.data;this.dispatchEvent(new CustomEvent("class-model-propagation-complete",{detail:{className:a,success:"success"===s,message:r}})),"error"===s&&e.error(`Model worker error for class '${a}': ${r}`)},this.listeners.push(t)},this.removeAllListeners=()=>{this.removeEventListener("class-model-propagation-pending",this.onClassModelPropagationStart),this.removeEventListener("class-model-propagation-complete",this.onClassModelPropagationComplete),this.listeners=[]},this.onClassModelPropagationStart=e=>{const t=e.detail.className,s=E.child({method:"onClassModelPropagationStart",className:t});this.addClassLock(t).then(()=>{s.info(`Lock created successfully for class: '${t}'`)}).catch(e=>{s.error(`Error creating lock for '${t}': ${e}`)})},this.onClassModelPropagationComplete=e=>{const t=E.child({method:"onClassModelPropagationComplete",args:{event:e}}),s=e.detail.className;this.clearClassLock(s).then(()=>{t.info(`Lock removed successfully for class: '${s}'`)}).catch(e=>{t.error(`Error removing lock for '${s}': ${e}`)})},this.onClassModelChanges=()=>{const e=E.child({listener:"classModelChanges"});return this.db.changes({since:"now",live:!0,include_docs:!0,filter:e=>"class"==e.type}).on("change",async t=>{const s=t.doc;if(s&&g(s)&&s.active){const t=s.name;e.info(`Class model was updated. Clearing '${t}' from cache.`),delete this.cache[t],e.info(`Successfully cleared '${t}' from cache.`)}else if(s&&g(s)&&!s.active){const t=s.name;e.info(`Class was deleted. Removing from '${t} from cache.'`)}})},this.onClassLock=e=>{const t=this.db.changes({since:"now",live:!0,include_docs:!0,filter:t=>"~lock"==t.type&&t._id==`~lock-propagation-${e}`});return this.listeners.push(t),t},this.addClassLock=async e=>{const t=E.child({method:"addClassLock",args:{className:e}});try{const s=await this.db.get(`~lock-propagation-${e}`);let a;s&&(a=s._rev);const r=await this.db.put({_id:`~lock-propagation-${e}`,type:"~Lock",_rev:a});return t.info("Adding class lock response",{response:r}),r.ok}catch(e){return t.error(`Error while adding class lock: ${e}`),!1}},this.clearClassLock=async e=>{const t=E.child({method:"clearClassLock",args:{className:e}});try{const s=await this.db.get(`~lock-propagation-${e}`);t.info("Fetched class lock",{document:s});const a=await this.db.remove(s);return t.info("Removing class lock response",{response:a}),a.ok}catch(e){return t.error(`Error while adding class lock: ${e}`),!1}},this.onClassDoc=e=>{const t=this.db.changes({since:"now",live:!0,include_docs:!0,filter:t=>t.type==e});return this.listeners.push(t),t},this.close=()=>{this.removeAllListeners(),this.modelWorker&&this.modelWorker.terminate()},this.getClass=async(e,t=!1)=>{if(!t&&this.cache[e]&&Date.now()<this.cache[e].ttl)return E.info("getClass -  retrieving class from cache",{ttl:this.cache[e].ttl}),this.cache[e];const s=await x.fetch(this,e);return s&&(s.ttl=Date.now()+9e5,this.cache[e]=s),s},this.findDocuments=async(e,t,s,a)=>{const r=E.child({method:"findDocuments",args:{selector:e,fields:t,skip:s,limit:a}});e.hasOwnProperty("active")||(e.active=!0);let i=Object.keys(e);r.info("Produced index fields from selector",{indexFields:i});let n={docs:[]};try{let i=await this.db.find({selector:e,fields:t,skip:s,limit:a});return r.info("Found",{result:i,selector:e}),n={docs:i.docs,selector:e,skip:s,limit:a},n}catch(t){return r.error("findDocument - error",t),{docs:[],error:t.toString(),selector:e,skip:s,limit:a}}},this.getClassModel=async e=>{let t={type:{$eq:"class"},name:{$eq:e}};try{let e=await this.findDocument(t);if(null==e)return null;let s=e;return E.info("getClassModel - result",{result:s}),s}catch(e){throw E.info("getClassModel - error",e),new Error(e)}},this.getAllClasses=async()=>{const e=E.child({method:"getAllClasses"});e.info("Requesting");let t=await this.getAllClassModels();e.info("Received classes models",{classModels:t});let s=[];for(const a of t){e.info(`Building class "${a.name}" from model`,{classModel:a});const t=await x.buildFromModel(this,a);s.push(t)}return e.info("Completed classes build"),s},this.addClass=async e=>{let t=e.getModel();E.info("addClass - got class model",{classModel:t});let s=await this.getClassModel(t.name);if(null==s){let s=await this.createDoc(t.name,"class",e,t);return E.info("addClass - result",{result:s}),s}return s},this.updateClass=async e=>{let t=await this.createDoc(e.getId(),"class",e,e.getModel());return E.info("updateClass - result",t),t},this.addDesignDocumentPKs=async(e,t,s=!1)=>{const a=E.child({method:"addDesignDocumentPKs",args:{className:e,pKs:t}}),r=t.map(e=>`doc.${e}`).join(", "),i=`function (doc) {\n            const hasAllKeys = ${t.map(e=>`doc.${e}`).join(" && ")};\n            if (hasAllKeys && doc.type === '${e}') {\n            emit([${r}], doc._id);\n            }\n        }`;a.info("Generated map code",{code:i});let n=`_design/${e}-group`;s&&(n=`_design/${e}-group-temp`);const o={_id:n,views:{by_pKeys:{map:i}},_rev:void 0};a.info("Prepared design document",{ddoc:o});try{const e=await this.db.get(n);o._rev=e._rev,await this.db.put(o),a.info("Design document updated successfully.")}catch(e){if("not_found"!==e.name)throw a.error("Error saving design document:",e),e;await this.db.put(o),a.info("Design document created successfully.")}return n},this.validateObjectByType=async(e,t,s)=>{const a=E.child({method:"validateObjectByType",args:{obj:e,type:t,schema:s}});let r={};switch(t){case"class":r=O;break;case"domain":r=T;break;default:if(!s)try{r=(await this.getClassModel(t)).schema}catch(e){return a.error(`Failed because of error: ${e}`),!1}}if(r)return await this.validateObject(e,t,r);throw new Error("Unable to retrieve schema to validate object against")},this.createDoc=async(e,t,s,a)=>{let r=s.buildSchema();E.info("createDoc - args",{docId:e,type:t,params:a,schema:r});let i=this.db,n=null,o=!1;try{if(e){const s=await this.getDocument(e);if(E.info("retrieved doc",{existingDoc:s}),s&&s.type===t)E.info("createDoc - assigning existing doc",{doc:s}),n=Object.assign({},s);else{if(s&&s.type!==t)throw new Error("createDoc - Existing document type differs");o=!0,n=this.prepareDoc(e,t,a)}}else e=`${t}-${this.lastDocId+1}`,n=this.prepareDoc(e,t,a),o=!0,E.info("createDoc - generated docId",e);E.info("createDoc - doc BEFORE elaboration (i.e. merge)",{doc:n,params:a});const s=Object.assign(Object.assign(Object.assign({},n),a),{_id:e,_rev:n._rev,updateTimestamp:(new Date).getTime()});E.info("createDoc - doc AFTER elaboration (i.e. merge)",{doc_:s});let r=await i.put(s);if(E.info("createDoc - Response after put",{response:r}),r.ok&&o)this.incrementLastDocId(),e=r.id;else{if(!r.ok)throw new Error("createDoc - error:"+r.ok);e=r.id}}catch(e){if("conflict"!==e.name)throw E.info("createDoc - Problem while putting doc",{error:e,document:n}),new Error("createDoc - Problem while putting doc"+e);E.info("createDoc - conflict! Ignoring..")}return n},this.deleteDocument=async e=>{const t=E.child({method:"deleteDocument",args:{_id:e}}),s=await this.db.get(e);if(!s)return t.error("Found no document with given id"),!1;try{return await this.db.put(Object.assign(Object.assign({},s),{active:!1})),!0}catch(e){return t.error(`Error while deleting document: ${e}`,{document:s}),!1}},this.cache={}}async initialize(e,t){this.connection=e,this.options=t,(null==t?void 0:t.name)&&(this.name=null==t?void 0:t.name);const a=e.match(/(?<=db-).*/);this.name=a?a[0]:e;let i=(await Promise.all([s.e(997),s.e(4500),s.e(6215),s.e(6571),s.e(9104),s.e(881),s.e(1929),s.e(1151),s.e(3462),s.e(3245),s.e(730),s.e(8959),s.e(5805),s.e(4635),s.e(386),s.e(7062),s.e(5582),s.e(5699),s.e(2708),s.e(5316),s.e(6556),s.e(799),s.e(7536),s.e(5126),s.e(6931),s.e(8984),s.e(9589),s.e(5403),s.e(2290),s.e(5495),s.e(9122),s.e(5840),s.e(873),s.e(4289),s.e(9761),s.e(4772),s.e(7461),s.e(1165),s.e(6808),s.e(9681),s.e(5850),s.e(5695),s.e(8951),s.e(1502),s.e(1748),s.e(1851),s.e(325),s.e(6055),s.e(6748),s.e(5448),s.e(9955),s.e(5391),s.e(9683),s.e(7243),s.e(5758),s.e(6891),s.e(9765),s.e(1871),s.e(8451),s.e(8349),s.e(8646),s.e(689),s.e(4669),s.e(9530),s.e(646),s.e(7003),s.e(3566),s.e(6575)]).then(s.bind(s,75312))).default;if(r.A.plugin(i),r.A.plugin(P(this)),null==t?void 0:t.plugins)for(let e of t.plugins)r.A.plugin(e);this.db=new r.A(e),this.cache={}}getDb(){return this.db}async getDbInfo(){return this.db.info()}getDbName(){return this.db.name}static async create(e,t){const s=new L;return await s.initialize(e,t),await s.initdb(),s}async getLastDocId(){let e=0;try{e=(await this.db.get("lastDocId")).value}catch(t){if("not_found"===t.name)return E.info("getLastDocId - not found. Must be first initialization."),e;E.error("checkdb - something went wrong",{error:t})}return e}async getSystem(){try{return await this.db.get("~system")}catch(e){if("not_found"===e.name)return E.info("get System - not found",e),null;throw E.error("getSystem - something went wrong",{error:e}),new Error(e)}}async loadPatches(){let e="patch";N.env.BUILDING&&(e="patch");try{let t=Number(this.patchCount);E.info(`loadPatches - preparing to load ${t} patches`);let s=await Promise.all(Array.from({length:t}).map((t,s)=>{var a=`${s}`.padStart(3,"0"),r=`${e}/patch-${a}.json`;return E.info("loadPatches - loading patch from path",{path:r}),(0,C.importJsonFile)(r)}));return s=s.map(e=>(E.info("loadPatches - Parsing patch",{patch:e}),e)),E.info("loadPatches - Successfully loaded patches"),E.info("loadPatches - patches",{patches:s}),s}catch(e){throw E.error("loadPatches - something went wrong",e),new Error(e)}}async applyPatch(e){try{return E.info("applyPatch - attempting to apply patch",{patch:e}),await this.db.bulkDocs(e.docs),E.info("applyPatch - Successfully applied patch",{version:e.version}),e.version}catch(e){throw E.error("applyPatch - something went wrong",e),new Error(e)}}async applyPatches(e){let t=e;try{this.patchCount=(0,C.countPatches)();const s=await this.loadPatches(),a=e?s.findIndex(t=>t.version===e)+1:0;if(E.info(`applyPatches - Starting to apply patches from index ${a}`),-1===a||a===s.length)return E.info("applyPatches - No patches to apply"),e;let r=s.slice(a);for(let e of r)t=await this.applyPatch(e);return E.info("applyPatches - Successfully applied patches till version",{version:t}),t}catch(e){throw E.error("applyPatches - something went wrong",e),new Error(e)}}async checkSystem(){let e,t=await this.getSystem();const s=await this.getDbInfo();if(E.info("checkSystem - current system doc",{system:t}),t){E.info("checkSystem - system doc already exists. Checking for updates",t);let a=await this.applyPatches(t.schemaVersion);e=Object.assign(Object.assign({},t),{appVersion:L.appVersion,dbInfo:s,schemaVersion:a,startupTime:(new Date).valueOf()})}else{e={_id:"~system",appVersion:L.appVersion,dbInfo:s,schemaVersion:void 0,startupTime:(new Date).valueOf()};let t=await this.applyPatches(e.schemaVersion);e.schemaVersion=t}try{await this.db.put(e)}catch(e){throw E.error("checkSystem - There was a problem while updating system",{error:e}),new Error(e)}E.info("checkSystem - updated system",{system:e})}async initdb(){return await this.initIndex(),await this.checkSystem(),this.setListeners(),this}async initIndex(){try{let e=await this.getLastDocId();if(e)E.info("initdb - db already initialized, consider purge");else{e=Number(e);let t=await this.db.put({_id:"lastDocId",value:++e});if(!t.ok)throw new Error("Got problem while putting doc"+t);this.lastDocId=e}this.lastDocId=Number(e)}catch(e){throw E.error("initdb -  something went wrong",e),new Error(e)}}async getDocument(e){let t;try{t=await this.db.get(e)}catch(e){if("not_found"===e.name)return E.info("getDocument - not found",e),null;throw E.info("getDocument - error",e),new Error(e)}return t}async getDocRevision(e){let t=null;try{let s=await this.getDocument(e);s&&(t=s._rev)}catch(e){throw E.info("getDocRevision - error",e),new Error(e)}return t}async findDocument(e,t=void 0,s=void 0,a=void 0){let r=await this.findDocuments(e,t,s,a);return r.docs.length>0?r.docs[0]:null}async getAllClassModels(){return(await this.findDocuments({type:{$eq:"class"}},["_id","name","description","schema"])).docs}async getClassModels(e){return(await this.getAllClassModels()).filter(t=>e.includes(t.name))}async incrementLastDocId(){let e=await this.getDocRevision("lastDocId");if(e)return await this.db.put({_id:"lastDocId",_rev:e,value:++this.lastDocId}),this.lastDocId}async reset(){return await this.destroyDb(),await new Promise(e=>setTimeout(e,2e3)),await this.initialize(this.connection,this.options),await this.initdb(),this}async destroyDb(){const e=E.child({method:"destroyDb"});try{this.db.destroy(null,()=>(e.info("Destroyed db"),!0))}catch(t){return e.error(`Error while destroying db: ${t}`),!1}}static async clear(e){return new Promise((t,s)=>{try{new r.A(e).destroy(null,()=>{E.info("clear - Destroyed db"),t(!0)})}catch(e){E.error("clear - Error while destroying db"+e),s(!1)}})}async validateObject(e,t,s){E.info("validateObject - given args",{obj:e,schema:s});let a=!0;try{for(let a of Object.values(s)){let s=e[a.name];if(E.info("validateObject - model",{model:a,value:s}),void 0===s&&a.config.mandatory){let e=`Property ${a.name} does not exist on the object.`;throw E.error(e),new Error(e)}if(!a.config.mandatory&&void 0===s){let e=`Property ${a.name} is not mandatory and does not exist on the object. Skipping validation of this attribute`;E.info(e);continue}switch(a.config.defaultValue&&void 0===s&&(E.info(`Property ${a.name} is missing, setting to default value.`),e[a.name]=a.config.defaultValue,s=e[a.name]),a.type){case"string":if(!a.config.isArray&&typeof s!==a.type)return E.info(`Property ${a.name} is not of type ${a.type}.`),!1;if(a.config.isArray&&!Array.isArray(s))return E.info(`Property ${a.name} is not an array.`),!1;if(a.config){if(a.config.maxLength&&s.length>a.config.maxLength)return E.info(`Property ${a.name} is longer than ${a.config.maxLength} characters.`),!1;if(a.config.encrypted){let e=j();if(console.log("decryptedString",e),null===e)return E.info(`Property ${a.name} is not encrypted correctly.`),!1}if(a.config.primaryKey){E.info("primaryKey check",{type:t,model:a,value:s});let e=await this.findDocuments({type:{$eq:t},[a.name]:{$eq:s}});if(e.docs.length>0)throw E.info(`A card with property ${a.name} already exists.`,e),new Error(`A card with property ${a.name} already exists.`)}}break;case"decimal":if(a.config){if(a.config.min&&s<a.config.min)return E.info(`Property ${a.name} is less than ${a.config.min}.`),!1;if(a.config.max&&s>a.config.max)return E.info(`Property ${a.name} is greater than ${a.config.max}.`),!1}break;case"integer":if(a.config.isArray||"number"==typeof s){if(a.config.isArray&&(!Array.isArray(s)||!s.every(e=>"number"==typeof e)))return E.info(`Property ${a.name} is not an array.`),!1}else E.info(`Property ${a.name} is not of type ${a.type}.`);if(a.config){if(a.config.min&&s<a.config.min)return E.info(`Property ${a.name} is less than ${a.config.min}.`),!1;if(a.config.max&&s>a.config.max)return E.info(`Property ${a.name} is greater than ${a.config.max}.`),!1}break;case"foreign_key":if(a.config,null==await this.getDocument(s))return E.info(`Foreign key ${s} does not exist.`),!1;break;case"object":E.info("Missing json validation. Skipping for now.");break;default:throw new Error("Unexpected type received")}}}catch(e){return E.info("validateObject - error",e),!1}return E.info("validateObject - result",{type:t,result:a}),a}prepareDoc(e,t,s){return E.info("prepareDoc - given args",{_id:e,type:t,params:s}),s._id=e,s.type=t,s.createTimestamp=(new Date).getTime(),s.active=!0,E.info("prepareDoc - after elaborations",{params:s}),s}}L.appVersion="0.0.1";const _=L;class B extends EventTarget{async addStack(e){let t;if("object"==typeof e&&e.name?t=await _.create(`db-${e.name}`,{plugins:[]}):"string"==typeof e&&(t=await _.create(`db-${e}`,{plugins:[]})),t){this.stacks.push(t);let e=window;return e.stacks&&e.stacks.push(t),t}}async resetAll(){try{for(const e of this.stacks)await e.reset()}catch(e){throw new Error(e)}}getStacks(){return this.stacks}getReadyState(){return this.readyState}async reset(){try{await this.resetAll(),await this.initStacks(this.config)}catch(e){throw new Error(e)}}constructor(...e){super(),this.config=[],this.stacks=[],this.logger=(0,a.A)().child({module:"client"}),this.initStacks=async e=>{for(const t of e)await this.addStack(t);this.readyState=!0,this.dispatchEvent(new CustomEvent("ready",{detail:{stacks:this.stacks}}))},this.getStack=e=>this.stacks.find(t=>t.name==e||t.connection==e),this.clearConnection=async e=>{const t=this.logger.child({method:"clearConnection"});try{if(!e)throw new Error("Connection name not provided");await _.clear(e),t.info("Internal database cleared")}catch(e){throw new Error(e)}},this.createClass=async(e,t)=>{const s=this.logger.child({method:"createClass"}),{type:a,description:r}=t;s.info("Args",{name:e,config:t});try{const t=await x.create(this.store,e,a,r,{});s.info(`class '${e}' created successfully.`,{classModel:t.getModel()})}catch(t){throw new Error(`Error during class '${e} creation. ${t}`)}s.info("Class created successfully")},this.createAttribute=async(e,t)=>{const s=this.logger.child({method:"createAttribute"}),{name:a,type:r,description:i,config:n}=t;s.info(`Creating attribute for class '${e}'`,{name:a,type:r,config:n});try{let t=await this.store.getClass(e);if(!t)throw new Error(`Failed to retrieve Class '${e}'`);{let o=await b.create(t,a,r,i,n);s.info(`Attribute '${a}' added to class '${e}'`,{attributeModel:o.getModel()})}}catch(e){throw s.error(`Error during attribute '${a}' creation: ${e}`),new Error(`Error during attribute '${a}' creation: ${e}`)}},this.readyState=!1;const t=this.logger.child({method:"constructor"});this.initStacks(e),this.addEventListener("ready",()=>t.info("DocStack client successfully initialized"))}}},92749:(e,t,s)=>{"use strict";s.a(e,async(e,t)=>{try{var a=s(31085),r=s(14041),i=s(25873),n=s(43705),o=s(20073),c=s(4002),l=s(73657),d=s(13653),u=e([c]);c=(u.then?(await u)():u)[0],(0,i.H)(document.getElementById("root")).render((0,a.jsx)(r.StrictMode,{children:(0,a.jsx)(d.M_,{config:["client-test"],children:(0,a.jsx)(n.Kq,{store:c.M,children:(0,a.jsx)(l.Kd,{basename:"/docstack/app",children:(0,a.jsx)(o.A,{})})})})})),t()}catch(e){t(e)}})},97174:(e,t,s)=>{var a={"./":10881,"./index":10881,"./index.ts":10881,"./patch/patch-000.json":48241};function r(e){var t=i(e);return s(t)}function i(e){if(!s.o(a,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return a[e]}r.keys=function(){return Object.keys(a)},r.resolve=i,e.exports=r,r.id=97174},98933:(e,t,s)=>{var a={"./simpleWorker":99246,"./simpleWorker.js":99246};function r(e){return Promise.resolve().then(()=>{if(!s.o(a,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s(a[e])})}r.keys=()=>Object.keys(a),r.id=98933,e.exports=r},99231:()=>{}},e=>{e.O(0,[997,4500,6215,6571,9104,881,1929,1151,3462,3245,730,8959,5805,4635,386,7062,5582,5699,2708,5316,6556,799,7536,5126,6931,8984,9589,5403,2290,5495,9122,5840,873,4289,9761,4772,7461,1165,6808,9681,5850,5695,8951,1502,1748,1851,325,6055,6748,5448,9955,5391,9683,7243,5758,6891,9765,1871,8451,8349,8646,689,4669,9530,646,7003,3566,6575],()=>e(e.s=92749)),e.O()}]);